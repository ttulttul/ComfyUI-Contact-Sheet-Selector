# Learnings

- Implementing delayed selections required splitting state into `active` and `pending`, with the promotion happening only after each execution so the UI can remain synchronous with ComfyUI's execution loop. The helper module now keeps the behaviour testable without the ComfyUI runtime.
- Canvas coordinate discrepancies surfaced because the frontend was mixing global canvas coordinates with node-local offsets. LiteGraph already hands widget handlers node-local coordinates, so the fix is to trust those first and only fall back to drag-and-scale transforms (still logged in detail) when the raw values look implausible.
- When diagnosing “no output” reports it helps to log every selection hand-off; the node now reports sanitized UI selections, warns when they resolve to an empty batch despite incoming data, falls back to the active set if a stale UI selection points past the new batch bounds, and infers batch size from the posted indices so fresh grids aren’t clipped.
- Persisting the “next selection” onto the node properties (with `graph.beforeChange()` / `afterChange()`) guarantees LiteGraph emits `graphChanged`, which keeps the auto-queue service honest about contact-sheet edits and serialises the selection alongside the workflow, while the backend fingerprints the pending selection so the execution cache can’t supply stale outputs.
